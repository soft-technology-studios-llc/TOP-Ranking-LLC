<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arcade Ultimate: Nebula & Breaker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #020205; font-family: 'Arial Black', sans-serif; touch-action: none; user-select: none; }
        canvas { display: block; }
        
        #capa-menu {
            position: fixed; inset: 0; background: radial-gradient(circle at center, #1a1a2e 0%, #020205 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000;
        }
        .btn-menu {
            padding: 20px 40px; margin: 15px; font-size: 1.5rem; color: white;
            font-weight: 900; border-radius: 20px; border: 2px solid rgba(255,255,255,0.1); cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 320px; text-transform: uppercase;
        }
        .btn-menu:hover { transform: scale(1.05); filter: brightness(1.2); }
        .btn-nebula { background: linear-gradient(45deg, #ff0080, #7000ff); box-shadow: 0 10px 30px rgba(255, 0, 128, 0.4); }
        .btn-breaker { background: linear-gradient(45deg, #00d4ff, #0044ff); box-shadow: 0 10px 30px rgba(0, 212, 255, 0.4); }

        .glass { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); }
        
        /* LA X ARRIBA EN MEDIO Y PEQUEÃ‘A */
        #btn-cerrar {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            width: 35px; height: 35px; background: rgba(255, 0, 0, 0.4);
            color: white; border: 1px solid white; border-radius: 50%;
            font-size: 16px; font-weight: bold; cursor: pointer;
            z-index: 4000; display: none; backdrop-filter: blur(5px);
        }

        #rblx-bubble {
            position: absolute; bottom: 30px; right: 30px; width: 95px; height: 95px;
            background: linear-gradient(135deg, #00f2fe, #4facfe); border-radius: 30px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; font-weight: 900; z-index: 2000; cursor: pointer;
            border: 3px solid white; animation: float 4s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translateY(0) rotate(-3deg); } 50% { transform: translateY(-25px) rotate(3deg); } }
        
        #corazon-roto {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 100px; display: none; pointer-events: none; z-index: 3000;
        }
        .animar-corazon { animation: heartBreak 0.8s forwards; display: block !important; }
        @keyframes heartBreak { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -200%) scale(3); opacity: 0; } }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<button id="btn-cerrar" onclick="volverAlMenu()">âœ•</button>

<div id="capa-menu">
    <h1 class="text-white text-6xl font-black mb-16 italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-600">ARCADE PRO</h1>
    <div id="menu-inicio">
        <button class="btn-menu bg-white/5" onclick="irASeleccion()">JUGAR</button>
    </div>
    <div id="menu-seleccion" class="hidden text-center">
        <button class="btn-menu btn-nebula" onclick="iniciarGame('nebula')">BLOCK NEBULA</button>
        <button class="btn-menu btn-breaker" onclick="iniciarGame('breaker')">ULTRA BREAKER</button>
    </div>
</div>

<div id="corazon-roto">ðŸ’”</div>

<div id="ui" class="hidden fixed top-0 w-full p-6 flex justify-between pointer-events-none z-50">
    <div class="glass p-4 rounded-2xl text-center min-w-[100px]">
        <div class="text-[8px] text-cyan-400 font-bold uppercase">Puntos</div>
        <div id="score" class="text-3xl font-black text-white">0</div>
    </div>
    <div class="glass p-4 rounded-2xl text-center min-w-[100px]">
        <div id="lives" class="text-xl font-black text-red-500 italic">3 VIDAS</div>
    </div>
</div>

<div id="rblx-bubble">
    <span class="text-xs">RBLX</span>
    <span id="rblx-count" class="text-4xl font-black">0</span>
</div>

<div id="transfer-modal" class="hidden fixed inset-0 bg-black/95 z-[5000] flex items-center justify-center p-8">
    <div class="glass border-cyan-500/30 p-12 rounded-[40px] text-center max-w-sm w-full">
        <h2 class="text-cyan-400 text-xs mb-3 font-black uppercase">Balance RBLX</h2>
        <div id="modal-rblx-count" class="text-8xl font-black text-white mb-10">0</div>
        <button id="transfer-btn" class="w-full bg-cyan-500 text-white py-6 rounded-2xl font-black text-2xl mb-6">TRANSFERIR</button>
        <button onclick="cerrarModal()" class="text-gray-500 font-bold">CERRAR</button>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const livesEl = document.getElementById('lives');
    const rblxEl = document.getElementById('rblx-count');
    const modalRblxEl = document.getElementById('modal-rblx-count');
    const transferModal = document.getElementById('transfer-modal');
    const btnCerrar = document.getElementById('btn-cerrar');
    
    let currentGame = null, gameActive = false, score = 0, lives = 3, rblxPoints = parseInt(localStorage.getItem('rblxPoints')) || 0;
    let particles = [], nebulaGrid = [], currentBlocks = [], draggingBlock = null;
    let dragOffsetX = 0, dragOffsetY = 0, lastPointerX = 0, lastPointerY = 0;
    rblxEl.innerText = rblxPoints;

    const paddle = { w: 150, h: 22, x: 0, y: 0 };
    const ball = { x: 0, y: 0, r: 10, dx: 0, dy: 0, speed: 7.5 };
    let bricks = [];

    function irASeleccion() {
        document.getElementById('menu-inicio').classList.add('hidden');
        document.getElementById('menu-seleccion').classList.remove('hidden');
    }

    function iniciarGame(tipo) {
        document.getElementById('capa-menu').classList.add('hidden');
        document.getElementById('ui').classList.remove('hidden');
        btnCerrar.style.display = 'block';
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        currentGame = tipo;
        score = 0; scoreEl.innerText = "0";
        gameActive = true;
        particles = [];

        if (tipo === 'breaker') {
            lives = 3; livesEl.innerText = "3 VIDAS";
            paddle.y = canvas.height - 130; paddle.x = canvas.width/2 - 75;
            createBricks(); resetBall();
        } else {
            livesEl.innerText = "NEBULA";
            nebulaGrid = Array(8).fill().map(() => Array(8).fill(0));
            generateNebulaBlocks();
        }
        requestAnimationFrame(gameLoop);
    }

    function volverAlMenu() {
        gameActive = false;
        document.getElementById('ui').classList.add('hidden');
        btnCerrar.style.display = 'none';
        document.getElementById('capa-menu').classList.remove('hidden');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function chequearRblx(meta) {
        if (score > 0 && score % meta === 0) {
            rblxPoints++;
            localStorage.setItem('rblxPoints', rblxPoints);
            rblxEl.innerText = rblxPoints;
        }
    }

    // --- LOGICA NEBULA: DESTRUCCIÃ“N ---
    function checkLinesNebula() {
        let rFull = [], cFull = [];
        for(let r=0; r<8; r++) if(nebulaGrid[r].every(v => v !== 0)) rFull.push(r);
        for(let c=0; c<8; c++) {
            let f = true; for(let r=0; r<8; r++) if(nebulaGrid[r][c] === 0) f = false;
            if(f) cFull.push(c);
        }
        rFull.forEach(r => {
            for(let c=0; c<8; c++) { createExplosion(c, r, nebulaGrid[r][c]); nebulaGrid[r][c] = 0; }
            score += 100;
        });
        cFull.forEach(c => {
            for(let r=0; r<8; r++) { if(nebulaGrid[r][c]) { createExplosion(c, r, nebulaGrid[r][c]); nebulaGrid[r][c] = 0; } }
            score += 100;
        });
        scoreEl.innerText = score;
        chequearRblx(600);
    }

    function createExplosion(c, r, col) {
        const sz = 40, off = (canvas.width - (8*sz))/2;
        for(let i=0; i<8; i++) {
            particles.push({x: c*sz+off+20, y: r*sz+150+20, dx: (Math.random()-0.5)*12, dy: (Math.random()-0.5)*12, life: 1, color: col});
        }
    }

    // --- DIBUJO ---
    function drawBox(x, y, w, h, color, neon = true) {
        ctx.save();
        if(neon) { ctx.shadowBlur = 15; ctx.shadowColor = color; }
        ctx.fillStyle = color;
        ctx.beginPath(); ctx.roundRect(x, y, w, h, 8); ctx.fill();
        ctx.restore();
    }

    function createBricks() {
        bricks = [];
        const cols = 7, rows = 5;
        const w = (canvas.width - 40) / cols;
        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                bricks.push({ x: c*w + 20, y: r*40 + 100, w: w-10, h: 30, color: `hsl(${r*50 + 180}, 80%, 50%)`, active: true });
            }
        }
    }

    function resetBall() {
        ball.x = canvas.width/2; ball.y = paddle.y - 20;
        ball.dx = 5; ball.dy = -ball.speed;
    }

    function updateBreaker() {
        ball.x += ball.dx; ball.y += ball.dy;
        if(ball.x < 10 || ball.x > canvas.width - 10) ball.dx *= -1;
        if(ball.y < 10) ball.dy *= -1;
        if(ball.y + ball.r > paddle.y && ball.x > paddle.x && ball.x < paddle.x + paddle.w) {
            ball.dy = -ball.speed; ball.y = paddle.y - ball.r;
        }
        bricks.forEach(b => {
            if(b.active && ball.x > b.x && ball.x < b.x + b.w && ball.y > b.y && ball.y < b.y + b.h) {
                b.active = false; ball.dy *= -1; score += 10;
                scoreEl.innerText = score; chequearRblx(300);
            }
        });
        if(ball.y > canvas.height) {
            lives--;
            document.getElementById('corazon-roto').classList.add('animar-corazon');
            setTimeout(() => document.getElementById('corazon-roto').classList.remove('animar-corazon'), 800);
            livesEl.innerText = lives + " VIDAS";
            if(lives <= 0) volverAlMenu(); else resetBall();
        }
    }

    function generateNebulaBlocks() {
        currentBlocks = [];
        const colors = ['#ff0080', '#00d4ff', '#ffcc00', '#4ade80'];
        const shapes = [[[1,1],[1,1]], [[1,1,1]], [[1]], [[1,1]], [[1,1,1],[0,1,0]]];
        for(let i=0; i<3; i++) {
            currentBlocks.push({
                shape: shapes[Math.floor(Math.random()*shapes.length)],
                color: colors[Math.floor(Math.random()*colors.length)],
                x: (canvas.width/2 - 160) + i*110, y: canvas.height - 180, active: true
            });
        }
    }

    function gameLoop() {
        if(!gameActive) return;
        ctx.fillStyle = '#020205'; ctx.fillRect(0,0,canvas.width, canvas.height);
        
        if(currentGame === 'breaker') {
            updateBreaker();
            bricks.forEach(b => b.active && drawBox(b.x, b.y, b.w, b.h, b.color));
            drawBox(paddle.x, paddle.y, paddle.w, paddle.h, '#00d4ff');
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
        } else {
            const sz = 40, off = (canvas.width - (8*sz))/2;
            for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
                ctx.strokeStyle = 'rgba(255,255,255,0.05)';
                ctx.strokeRect(c*sz + off, r*sz + 150, sz, sz);
                if(nebulaGrid[r][c]) drawBox(c*sz+off+1, r*sz+150+1, sz-2, sz-2, nebulaGrid[r][c]);
            }
            currentBlocks.forEach((b, i) => {
                if(!b.active) return;
                let bx = (draggingBlock === i) ? lastPointerX - dragOffsetX : b.x;
                let by = (draggingBlock === i) ? lastPointerY - dragOffsetY : b.y;
                b.shape.forEach((row, r) => row.forEach((v, c) => {
                    if(v) drawBox(bx + c*30, by + r*30, 26, 26, b.color, false);
                }));
            });
        }

        particles.forEach((p, i) => {
            p.x += p.dx; p.y += p.dy; p.life -= 0.02;
            ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, 4, 4);
            if(p.life <= 0) particles.splice(i, 1);
        });
        ctx.globalAlpha = 1;
        requestAnimationFrame(gameLoop);
    }

    const getPos = (e) => {
        const r = canvas.getBoundingClientRect();
        const cx = e.clientX || (e.touches && e.touches[0].clientX);
        const cy = e.clientY || (e.touches && e.touches[0].clientY);
        return { x: cx - r.left, y: cy - r.top };
    }

    window.onmousedown = window.ontouchstart = (e) => {
        const p = getPos(e); lastPointerX = p.x; lastPointerY = p.y;
        if(currentGame === 'nebula') {
            currentBlocks.forEach((b, i) => {
                if(b.active && p.x > b.x && p.x < b.x+100 && p.y > b.y && p.y < b.y+100) {
                    draggingBlock = i; dragOffsetX = p.x - b.x; dragOffsetY = p.y - b.y;
                }
            });
        }
    };
    window.onmousemove = window.ontouchmove = (e) => {
        if(!gameActive) return;
        const p = getPos(e); lastPointerX = p.x; lastPointerY = p.y;
        if(currentGame === 'breaker') paddle.x = Math.max(0, Math.min(canvas.width - paddle.w, p.x - paddle.w/2));
    };
    window.onmouseup = window.ontouchend = () => {
        if(currentGame === 'nebula' && draggingBlock !== null) {
            let b = currentBlocks[draggingBlock];
            let sz = 40, off = (canvas.width - (8*sz))/2;
            let gx = Math.round((lastPointerX - dragOffsetX - off)/sz);
            let gy = Math.round((lastPointerY - dragOffsetY - 150)/sz);
            let fits = true;
            b.shape.forEach((row, r) => row.forEach((v, c) => {
                if(v) {
                    let tr = gy+r, tc = gx+c;
                    if(tr<0||tr>=8||tc<0||tc>=8||nebulaGrid[tr][tc]) fits = false;
                }
            }));
            if(fits) {
                b.shape.forEach((row, r) => row.forEach((v, c) => {
                    if(v) nebulaGrid[gy+r][gx+c] = b.color;
                }));
                b.active = false; score += 40; scoreEl.innerText = score;
                checkLinesNebula();
                if(currentBlocks.every(x => !x.active)) generateNebulaBlocks();
            }
            draggingBlock = null;
        }
    };
    function cerrarModal() { transferModal.classList.add('hidden'); }
    document.getElementById('rblx-bubble').onclick = () => {
        modalRblxEl.innerText = rblxPoints;
        transferModal.classList.remove('hidden');
    };
    document.getElementById('transfer-btn').onclick = () => {
        window.open(`https://wa.me/50373826693?text=Tengo ${rblxPoints} puntos Rblx`, '_blank');
        rblxPoints = 0; localStorage.setItem('rblxPoints', 0); rblxEl.innerText = "0"; cerrarModal();
    };
</script>
</body>
</html>